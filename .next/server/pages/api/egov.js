"use strict";(()=>{var e={};e.id=772,e.ids=[772],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},788:(e,t,o)=>{o.r(t),o.d(t,{config:()=>m,default:()=>c,routeModule:()=>f});var n={};o.r(n),o.d(n,{default:()=>handler});var r=o(802),a=o(153),i=o(249);!function(){var e=Error("Cannot find module 'mongoose'");throw e.code="MODULE_NOT_FOUND",e}();let s=process.env.MONGODB_URI||"mongodb://mongo:27017/egovdb";if(!s)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let d=global.mongoose;async function connectToDatabase(){return d.conn||(d.promise||(d.promise=Object(function(){var e=Error("Cannot find module 'mongoose'");throw e.code="MODULE_NOT_FOUND",e}())(s).then(e=>e)),d.conn=await d.promise),d.conn}d||(d=global.mongoose={conn:null,promise:null}),function(){var e=Error("Cannot find module 'mongoose'");throw e.code="MODULE_NOT_FOUND",e}();let l=Object(function(){var e=Error("Cannot find module 'mongoose'");throw e.code="MODULE_NOT_FOUND",e}())({userId:{type:String,required:!0,unique:!0},citizenId:String,firstName:String,middleName:String,lastName:String,dateOfBirthString:String,mobile:String,email:String,notification:Boolean,createdAt:{type:Date,default:Date.now}}),u=Object(function(){var e=Error("Cannot find module 'mongoose'");throw e.code="MODULE_NOT_FOUND",e}()).User||Object(function(){var e=Error("Cannot find module 'mongoose'");throw e.code="MODULE_NOT_FOUND",e}())("User",l);async function handler(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{appId:o,mToken:n}=e.body||{};if(!o||!n)return t.status(400).json({error:"appId and mToken are required in body"});let r=process.env.CONSUMER_KEY,a=process.env.CONSUMER_SECRET;if(!r||!a)return t.status(500).json({error:"Missing CONSUMER_KEY or CONSUMER_SECRET in environment"});try{let e=`https://api.egov.go.th/ws/auth/validate?ConsumerSecret=${encodeURIComponent(a)}&AgentID=${encodeURIComponent("8a816448-0207-45f4-8613-65b0ad80afd0")}`,i=await fetch(e,{method:"GET",headers:{"Consumer-Key":r,"Content-Type":"application/json"}}),s=await i.json().catch(()=>null);if(!i.ok)return t.status(502).json({step:"validate",ok:!1,body:s});let d=s?.Result||s?.result||s?.Token;if(!d)return t.status(502).json({step:"validate",ok:!1,message:"Token not found"});let l=await fetch("https://api.egov.go.th/ws/dga/czp/uat/v1/core/shield/data/deproc",{method:"POST",headers:{"Consumer-Key":r,"Content-Type":"application/json",Token:d},body:JSON.stringify({appId:o,mToken:n})}),c=await l.json().catch(()=>null);if(!l.ok)return t.status(502).json({step:"deproc",ok:!1,body:c});let m=c?.result||c?.data||c,f=m&&["userId","citizenId","firstName","lastName","dateOfBirthString","mobile","email","notification"].every(e=>e in m);if(!f)return t.status(200).json({message:"Unexpected data",deprocJson:c});let p={userId:m.userId,citizenId:m.citizenId,firstName:m.firstName,middleName:m.middleName??null,lastName:m.lastName,dateOfBirthString:m.dateOfBirthString,mobile:m.mobile,email:m.email,notification:!!m.notification};await connectToDatabase();let g=await u.findOneAndUpdate({userId:p.userId},p,{upsert:!0,new:!0});t.status(200).json({saved:g})}catch(e){console.error(e),t.status(500).json({error:String(e)})}}let c=(0,i.l)(n,"default"),m=(0,i.l)(n,"config"),f=new r.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/egov",pathname:"/api/egov",bundlePath:"",filename:""},userland:n})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),o=t.X(0,[222],()=>__webpack_exec__(788));module.exports=o})();